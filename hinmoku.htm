<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>品目マスタ入力</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  label { display: block; margin-top: 10px; }
  input, textarea { width: 300px; padding: 5px; }
  button { margin-top: 15px; padding: 8px 20px; }
  table { margin-top: 20px; border-collapse: collapse; width: 90%; }
  th, td { border: 1px solid #ccc; padding: 6px; }
</style>
</head>
<body>

<h2>アクア・ノヴァ 販売管理　【 品目マスタ入力 】</h2>

<!-- コード番号（自動採番） -->
<label>品目コード（自動採番）</label>
<input type="text" id="id" readonly style="background:#eee;">

<!-- 入力フォーム -->
<label>品目名</label>
<input type="text" id="name">

<label>単価</label>
<input type="number" id="unit_price" step="1">

<label>単位</label>
<input type="text" id="unit">

<label>税区分</label>
<input type="text" id="tax_category" placeholder="例：課税 / 非課税 / 免税 など">

<label>備考</label>
<textarea id="note"></textarea>

<!-- 操作ボタン -->
<br>
<button onclick="insertData()">登録</button>
<button onclick="updateData()">更新</button>
<button onclick="deleteData()">削除</button>
<button onclick="loadList()">一覧表示</button>

<!-- 一覧表示 -->
<div id="listArea"></div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Supabase 設定
  const SUPABASE_URL = "https://omzcbfjtwyygvvgxsiov.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_Plndzp1kowyp6OgTwTGwHA_iUIO0ae0";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 現在選択中のID
  let currentId = null;

  // ----------------------------
  // 登録
  // ----------------------------
  async function insertData() {
    const data = collectForm();

    const { error } = await supabase.from("hinmoku").insert([data]);
    if (error) {
      alert("登録エラー: " + error.message);
    } else {
      alert("登録しました");
      clearForm();
      loadList();
    }
  }

  // ----------------------------
  // 更新
  // ----------------------------
  async function updateData() {
    if (!currentId) {
      alert("一覧から編集する行を選択してください");
      return;
    }

    const data = collectForm();

    const { error } = await supabase
      .from("hinmoku")
      .update(data)
      .eq("id", currentId);

    if (error) {
      alert("更新エラー: " + error.message);
    } else {
      alert("更新しました");
      clearForm();
      loadList();
    }
  }

  // ----------------------------
  // 削除
  // ----------------------------
  async function deleteData() {
    if (!currentId) {
      alert("一覧から削除する行を選択してください");
      return;
    }

    if (!confirm("本当に削除しますか？")) return;

    const { error } = await supabase
      .from("hinmoku")
      .delete()
      .eq("id", currentId);

    if (error) {
      alert("削除エラー: " + error.message);
    } else {
      alert("削除しました");
      clearForm();
      loadList();
    }
  }

  // ----------------------------
  // 一覧表示
  // ----------------------------
  async function loadList() {
    const { data, error } = await supabase
      .from("hinmoku")
      .select("*")
      .order("name");

    if (error) {
      alert("一覧取得エラー: " + error.message);
      return;
    }

    let html = "<table><tr><th>コード</th><th>品目名</th><th>単価</th><th>単位</th><th>税区分</th><th>選択</th></tr>";

    data.forEach(row => {
      html += `
        <tr>
          <td>${row.id}</td>
          <td>${row.name || ""}</td>
          <td>${row.unit_price ?? ""}</td>
          <td>${row.unit || ""}</td>
          <td>${row.tax_category || ""}</td>
          <td><button onclick='selectRow("${row.id}")'>選択</button></td>
        </tr>
      `;
    });

    html += "</table>";
    document.getElementById("listArea").innerHTML = html;
  }

  // ----------------------------
  // 行選択 → フォームへ反映
  // ----------------------------
  async function selectRow(id) {
    currentId = id;

    const { data, error } = await supabase
      .from("hinmoku")
      .select("*")
      .eq("id", id)
      .single();

    if (error) {
      alert("データ取得エラー: " + error.message);
      return;
    }

    document.getElementById("id").value = data.id;
    document.getElementById("name").value = data.name || "";
    document.getElementById("unit_price").value = data.unit_price ?? "";
    document.getElementById("unit").value = data.unit || "";
    document.getElementById("tax_category").value = data.tax_category || "";
    document.getElementById("note").value = data.note || "";
  }

  // ----------------------------
  // フォーム → DB項目
  // ----------------------------
  function collectForm() {
    return {
      name: document.getElementById("name").value,
      unit_price: document.getElementById("unit_price").value
        ? Number(document.getElementById("unit_price").value)
        : null,
      unit: document.getElementById("unit").value,
      tax_category: document.getElementById("tax_category").value,
      note: document.getElementById("note").value
    };
  }

  // ----------------------------
  // フォームクリア
  // ----------------------------
  function clearForm() {
    document.querySelectorAll("input, textarea").forEach(el => el.value = "");
    currentId = null;
  }

  // 画面表示時に一覧を自動表示したい場合はコメント解除
  // loadList();

</script>

</body>
</html>