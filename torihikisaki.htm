<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>取引先マスタ入力</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  label { display: block; margin-top: 10px; }
  input, textarea { width: 300px; padding: 5px; }
  button { margin-top: 15px; padding: 8px 20px; }
  table { margin-top: 20px; border-collapse: collapse; width: 90%; }
  th, td { border: 1px solid #ccc; padding: 6px; }
</style>
</head>
<body>

<h2>アクア・ノヴァ 販売管理　【 取引先マスタ入力 】</h2>

<!-- コード番号（自動採番） -->
<label>コード番号（自動採番）</label>
<input type="text" id="id" readonly style="background:#eee;">

<!-- 入力フォーム -->
<label>会社名カナ</label>
<input type="text" id="kana">

<label>会社名</label>
<input type="text" id="name">

<label>部署</label>
<input type="text" id="department">

<label>担当者</label>
<input type="text" id="person">

<label>郵便番号</label>
<input type="text" id="postal_code">

<label>住所</label>
<textarea id="address"></textarea>

<label>電話</label>
<input type="text" id="tel">

<label>FAX</label>
<input type="text" id="fax">

<label>インボイス番号</label>
<input type="text" id="invoice_number">

<label>請求書送付先（メール or URL）</label>
<input type="text" id="billing_email_or_url">

<h3>振込先情報</h3>

<label>銀行名</label>
<input type="text" id="bank_name">

<label>支店名</label>
<input type="text" id="bank_branch">

<label>種別＋口座番号</label>
<input type="text" id="bank_account">

<label>口座名義</label>
<input type="text" id="account_holder">

<!-- 操作ボタン -->
<br>
<button onclick="insertData()">登録</button>
<button onclick="updateData()">更新</button>
<button onclick="deleteData()">削除</button>
<button onclick="loadList()">一覧表示</button>

<!-- 一覧表示 -->
<div id="listArea"></div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://omzcbfjtwyygvvgxsiov.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_Plndzp1kowyp6OgTwTGwHA_iUIO0ae0";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const SELF_ID = "00000000-0000-0000-0000-000000000001";
  let currentId = null;

  // ----------------------------
  // 登録
  // ----------------------------
  async function insertData() {
    const data = collectForm();

    const { error } = await supabase.from("torihikisaki").insert([data]);
    if (error) {
      alert("登録エラー: " + error.message);
    } else {
      alert("登録しました");
      clearForm();
      loadList();
    }
  }

  // ----------------------------
  // 更新
  // ----------------------------
  async function updateData() {
    if (!currentId) {
      alert("一覧から編集する行を選択してください");
      return;
    }

    const data = collectForm();

    const { error } = await supabase
      .from("torihikisaki")
      .update(data)
      .eq("id", currentId);

    if (error) {
      alert("更新エラー: " + error.message);
    } else {
      alert("更新しました");
      clearForm();
      loadList();
    }
  }

  // ----------------------------
  // 削除
  // ----------------------------
  async function deleteData() {
    if (!currentId) {
      alert("一覧から削除する行を選択してください");
      return;
    }

    if (currentId === SELF_ID) {
      alert("自社レコードは削除できません");
      return;
    }

    if (!confirm("本当に削除しますか？")) return;

    const { error } = await supabase
      .from("torihikisaki")
      .delete()
      .eq("id", currentId);

    if (error) {
      alert("削除エラー: " + error.message);
    } else {
      alert("削除しました");
      clearForm();
      loadList();
    }
  }

  // ----------------------------
  // 一覧表示
  // ----------------------------
  async function loadList() {
    const { data, error } = await supabase
      .from("torihikisaki")
      .select("*")
      .order("kana");

    if (error) {
      alert("一覧取得エラー: " + error.message);
      return;
    }

    let html = "<table><tr><th>コード</th><th>カナ</th><th>会社名</th><th>担当者</th><th>選択</th></tr>";

    data.forEach(row => {
      html += `
        <tr>
          <td>${row.id}</td>
          <td>${row.kana || ""}</td>
          <td>${row.name}</td>
          <td>${row.person || ""}</td>
          <td><button onclick='selectRow("${row.id}")'>選択</button></td>
        </tr>
      `;
    });

    html += "</table>";
    document.getElementById("listArea").innerHTML = html;
  }

  // ----------------------------
  // 行選択 → フォームへ反映
  // ----------------------------
  async function selectRow(id) {
    currentId = id;

    const { data, error } = await supabase
      .from("torihikisaki")
      .select("*")
      .eq("id", id)
      .single();

    if (error) {
      alert("データ取得エラー: " + error.message);
      return;
    }

    document.getElementById("id").value = data.id;
    document.getElementById("kana").value = data.kana || "";
    document.getElementById("name").value = data.name || "";
    document.getElementById("department").value = data.department || "";
    document.getElementById("person").value = data.person || "";
    document.getElementById("postal_code").value = data.postal_code || "";
    document.getElementById("address").value = data.address || "";
    document.getElementById("tel").value = data.tel || "";
    document.getElementById("fax").value = data.fax || "";
    document.getElementById("invoice_number").value = data.invoice_number || "";
    document.getElementById("billing_email_or_url").value = data.billing_email_or_url || "";
    document.getElementById("bank_name").value = data.bank_name || "";
    document.getElementById("bank_branch").value = data.bank_branch || "";
    document.getElementById("bank_account").value = data.bank_account || "";
    document.getElementById("account_holder").value = data.account_holder || "";
  }

  // ----------------------------
  // フォーム → DB項目
  // ----------------------------
  function collectForm() {
    return {
      kana: document.getElementById("kana").value,
      name: document.getElementById("name").value,
      department: document.getElementById("department").value,
      person: document.getElementById("person").value,
      postal_code: document.getElementById("postal_code").value,
      address: document.getElementById("address").value,
      tel: document.getElementById("tel").value,
      fax: document.getElementById("fax").value,
      invoice_number: document.getElementById("invoice_number").value,
      billing_email_or_url: document.getElementById("billing_email_or_url").value,
      bank_name: document.getElementById("bank_name").value,
      bank_branch: document.getElementById("bank_branch").value,
      bank_account: document.getElementById("bank_account").value,
      account_holder: document.getElementById("account_holder").value
    };
  }

  // ----------------------------
  // フォームクリア
  // ----------------------------
  function clearForm() {
    document.querySelectorAll("input, textarea").forEach(el => el.value = "");
    currentId = null;
  }

</script>

</body>
</html>