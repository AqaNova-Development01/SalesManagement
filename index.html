<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アクア・ノヴァ 販売管理システム｜メニュー</title>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://omzcbfjtwyygvvgxsiov.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Plndzp1kowyp6OgTwTGwHA_iUIO0ae0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ★ 連携状態フラグ
    let mfConnected = false;

    // ----------------------------
    // MF連携状態の取得（DB直読み版）
    // ----------------------------
    async function loadMFStatus() {
      try {
        const { data, error } = await supabase
          .from("mf_tokens")
          .select("updated_at")
          .eq("id", 1)
          .maybeSingle();   // ← ここが重要！
    
        const btn = document.getElementById("btn-mf-connect");
        const status = document.getElementById("mf-status");
    
        if (error) {
          console.error("DBエラー:", error);
          status.textContent = "状態取得エラー";
          return;
        }
    
        if (data) {
          mfConnected = true;
          btn.disabled = true;
          status.textContent = `連携済み（${data.updated_at}）`;
        } else {
          mfConnected = false;
          btn.disabled = false;
          status.textContent = "未連携";
        }
    
      } catch (e) {
        console.error("MF連携状態取得エラー:", e);
      }
    }

    // ----------------------------
    // ログイン済みチェック
    // ----------------------------
    async function checkLogin() {
      const { data } = await supabase.auth.getSession();
      if (!data.session) {
        window.location.href = "https://aqanova-development01.github.io/SalesManagement/login.html";
        return;
      }

      const user = data.session.user;

      // ★ public.users から role を取得
      const { data: userInfo } = await supabase
        .from("users")
        .select("role")
        .eq("id", user.id)
        .single();

      const role = userInfo?.role || "user";

      // ★ admin 以外は非表示
      if (role !== "admin") {
        document.getElementById("master-section").style.display = "none";
        document.getElementById("user-section").style.display = "none";
      } else {
        btnUsercreate.disabled = true;
      }

      // ★ MF連携状態を読み込み
      loadMFStatus();
    }

    // ----------------------------
    // MFクラウドと連携する（未連携のときだけ）
    // ----------------------------
    function connectMF() {
      if (mfConnected) {
        alert("すでにMFクラウドと連携済みです。");
        return;
      }
      window.location.href = "https://omzcbfjtwyygvvgxsiov.supabase.co/functions/v1/mf_authorize";
    }

    // ----------------------------
    // ログアウト
    // ----------------------------
    async function logout() {
      await supabase.auth.signOut();
      window.location.href = "https://aqanova-development01.github.io/SalesManagement/login.html";
    }

    window.logout = logout;
    window.connectMF = connectMF;

    checkLogin();
  </script>

  <style>
    body {
      font-family: sans-serif;
      padding: 40px;
      max-width: 500px;
      margin: auto;
    }
    h2 {
      margin-bottom: 30px;
    }
    h3 {
      margin-top: 30px;
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
    }
    button {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      font-size: 16px;
    }
    .mf-status {
      font-size: 14px;
      color: #555;
      margin-top: -5px;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>

  <h2>アクア・ノヴァ 販売管理システム｜メニュー</h2>

  <!-- 売上・仕入 -->
  <h3>売上・仕入</h3>
  <button onclick="location.href='list.html?kubun=UR&torihikisaki_id=TK00000'">売上一覧</button>
  <button onclick="location.href='uriage.html?kubun=UR'">売上入力</button>

  <button onclick="location.href='list.html?kubun=KI'">仕入一覧</button>
  <button onclick="location.href='uriage.html?kubun=KI'">仕入入力</button>

  <!-- 入出金 -->
  <h3>入出金</h3>
  <button onclick="location.href='torihiki.html?kubun=NY'">入金入力</button>
  <button onclick="location.href='torihiki.html?kubun=SI'">出金入力</button>

  <!-- 見積・納品・発注 -->
  <h3>見積・発注</h3>
  <button onclick="location.href='---koujityu---.html'">見積書作成</button>
  <button onclick="location.href='---koujityu---.html'">納品書作成</button>
  <button onclick="location.href='---koujityu---.html'">発注書作成</button>

  <!-- 帳票出力 -->
  <h3>帳票出力</h3>
  <button onclick="location.href='kake_summary.html?kubun=UR'">売掛集計</button>
  <button onclick="location.href='kake_summary.html?kubun=KI'">買掛集計</button>
  <button onclick="location.href='---koujityu---.html'">請求書</button>
  <button onclick="location.href='---koujityu---.html'">見積書（PDF）</button>
  <button onclick="location.href='---koujityu---.html'">納品書（PDF）</button>
  <button onclick="location.href='---koujityu---.html'">発注書（PDF）</button>
  <button onclick="location.href='---koujityu---.html'">領収書</button>

  <!-- データ出力（CSV） -->
  <h3>データ出力（CSV）</h3>
  <button onclick="location.href='torihiki_tax_summary.html?kubun=UR'">取引先別月次売上 CSV</button>
  <button onclick="location.href='torihiki_tax_summary.html?kubun=KI'">取引先別月次買掛 CSV</button>
  <button onclick="location.href='---koujityu---.html'">請求 CSV</button>
  <button onclick="location.href='---koujityu---.html'">見積 CSV</button>
  <button onclick="location.href='---koujityu---.html'">納品 CSV</button>

  <!-- マスタ管理 -->
  <div id="master-section">
    <h3>マスタ管理</h3>
    <button onclick="location.href='torihikisaki-list.html'">取引先マスター</button>
    <button onclick="location.href='hinmoku-list.html'">品目マスター</button>

    <!-- ★ MFクラウド連携 -->
    <div class="mf-status" id="mf-status">状態：確認中...</div>
    <button id="btn-mf-connect" onclick="connectMF()">MFクラウド連携</button>
  </div>

  <!-- ユーザー設定 -->
  <div id="user-section">
    <h3>ユーザー</h3>
    <button id="btnUsercreate" onclick="location.href='admin-create-user.html'">ユーザー作成</button>
  </div>

  <h3>ログアウト</h3>
  <button onclick="logout()">ログアウト</button>

</body>
</html>
