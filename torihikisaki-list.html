<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å–å¼•å…ˆä¸€è¦§ï¼ˆMFé€£æºï¼‹ãƒ­ã‚°ä»˜ãï¼‰</title>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://omzcbfjtwygvyvgxsio.supabase.co",
      "sb-publishable-key"
    );

    const params = new URLSearchParams(window.location.search);
    const from = params.get("from");

    // ----------------------------
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ­ã‚°ä»˜ãï¼‰
    // ----------------------------
    async function checkLogin() {
      const { data, error } = await supabase.auth.getSession();

      console.log("ğŸ” getSession data:", data);
      console.log("ğŸ” getSession error:", error);

      if (!data.session) {
        console.log("âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã— â†’ login.html ã¸é·ç§»");
        window.location.href = "login.html";
        return false;
      }

      console.log("âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿:", data.session.user.id);
      return true;
    }

    // ----------------------------
    // MFåŒæœŸï¼ˆ1ä»¶ãƒ»ãƒ­ã‚°ä»˜ãï¼‰
    // ----------------------------
    async function syncPartner(id) {
      console.log("ğŸ”„ åŒæœŸé–‹å§‹:", id);

      const btn = document.getElementById(`sync-${id}`);
      btn.disabled = true;
      btn.textContent = "åŒæœŸä¸­...";

      const res = await fetch(
        "https://omzcbfjtwygvyvgxsio.supabase.co/functions/v1/mf_sync_partner",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id }),
        }
      );

      console.log("ğŸ“¡ EdgeFunctionãƒ¬ã‚¹ãƒãƒ³ã‚¹:", res);

      if (res.ok) {
        console.log("âœ… åŒæœŸæˆåŠŸ");
        alert("MFé€£æºãŒå®Œäº†ã—ã¾ã—ãŸ");
        loadList();
      } else {
        const text = await res.text();
        console.log("âŒ åŒæœŸå¤±æ•—:", text);
        alert("åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ");
        btn.disabled = false;
        btn.textContent = "åŒæœŸ";
      }
    }

    // ----------------------------
    // ä¸€è¦§èª­ã¿è¾¼ã¿ï¼ˆãƒ­ã‚°ä»˜ãï¼‰
    // ----------------------------
    async function loadList() {
      const filter = document.getElementById("filter").value.trim();

      let query = supabase
        .from("torihikisaki")
        .select("*")
        .order("kana");

      if (filter) {
        query = query.or(
          `id.ilike.%${filter}%,name.ilike.%${filter}%,kana.ilike.%${filter}%,address.ilike.%${filter}%,department.ilike.%${filter}%,person.ilike.%${filter}%`
        );
      }

      console.log("â–¶ï¸ å®Ÿè¡Œã‚¯ã‚¨ãƒª:", query);

      let { data, error } = await query;

      console.log("ğŸ“¥ SELECT data:", data);
      console.log("âš ï¸ SELECT error:", error);

      if (error) {
        alert("ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼: " + error.message);
        return;
      }

      let html = `
        <table>
          <tr>
            <th>é¸æŠ</th>
            <th>ã‚³ãƒ¼ãƒ‰</th>
            <th>ä¼šç¤¾å</th>
            <th>ã‚«ãƒŠ</th>
            <th>ä½æ‰€</th>
            <th>éƒ¨ç½²</th>
            <th>æ‹…å½“è€…</th>
            <th>MFé€£æº</th>
            <th>åŒæœŸ</th>
          </tr>
      `;

      data.forEach(row => {
        const safeId = row.id.replace(/'/g, "\\'");
        const mfStatus = row.mf_partner_id ? "é€£æºæ¸ˆ" : "æœªé€£æº";
        const syncLabel = row.mf_partner_id ? "å†åŒæœŸ" : "åŒæœŸ";

        html += `
          <tr>
            <td><button onclick="selectRow('${safeId}')">é¸æŠ</button></td>
            <td>${row.id}</td>
            <td>${row.name}</td>
            <td>${row.kana || ""}</td>
            <td>${row.address || ""}</td>
            <td>${row.department || ""}</td>
            <td>${row.person || ""}</td>
            <td>${mfStatus}</td>
            <td>
              <button id="sync-${row.id}" onclick="syncPartner('${safeId}')">
                ${syncLabel}
              </button>
            </td>
          </tr>
        `;
      });

      html += "</table>";
      document.getElementById("listArea").innerHTML = html;
    }

    // ----------------------------
    // åˆæœŸå‡¦ç†
    // ----------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      console.log("ğŸš€ ç”»é¢ãƒ­ãƒ¼ãƒ‰é–‹å§‹");

      if (!(await checkLogin())) return;

      loadList();
    });

    // ----------------------------
    // è¡Œé¸æŠ
    // ----------------------------
    function selectRow(id) {
      console.log("â¡ï¸ è¡Œé¸æŠ:", id);

      if (from) {
        window.location.href = `${from}.html?torihikisaki_id=${id}`;
      } else {
        window.location.href = "torihikisaki.html?id=" + id;
      }
    }

    function goNew() {
      console.log("ğŸ†• æ–°è¦ä½œæˆã¸");

      if (from) {
        window.location.href = `${from}.html`;
      } else {
        window.location.href = "torihikisaki.html";
      }
    }

    window.selectRow = selectRow;
    window.goNew = goNew;
    window.loadList = loadList;
    window.syncPartner = syncPartner;
  </script>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { padding: 8px; width: 300px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
  </style>
</head>

<body>

  <h2>å–å¼•å…ˆä¸€è¦§ï¼ˆMFé€£æºï¼‹ãƒ­ã‚°ä»˜ãï¼‰</h2>

  <input id="filter" type="text" placeholder="ã‚³ãƒ¼ãƒ‰ / ä¼šç¤¾å / ã‚«ãƒŠ / éƒ¨ç½² / æ‹…å½“è€…">
  <button onclick="loadList()">æ¤œç´¢</button>

  <div id="listArea"></div>

  <br>
  <button onclick="goNew()">æ–°è¦ä½œæˆã¸</button>
  <button onclick="location.href='index.html'">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>

</body>
</html>
