<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>取引先一覧</title>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://omzcbfjtwyygvvgxsiov.supabase.co",
      "sb_publishable_Plndzp1kowyp6OgTwTGwHA_iUIO0ae0"
    );

    const params = new URLSearchParams(window.location.search);
    const from = params.get("from");   // 呼び出し元画面名（例：hinmoku, uriage, shiire など）

    // ----------------------------
    // 一覧読み込み
    // ----------------------------
    async function loadList() {
      const filter = document.getElementById("filter").value.trim();

      let query = supabase
        .from("torihikisaki")
        .select("*")
        .order("kana");

      if (filter) {
        query = query.or(`id.ilike.%${filter}%,name.ilike.%${filter}%,kana.ilike.%${filter}%,address.ilike.%${filter}%,department.ilike.%${filter}%,person.ilike.%${filter}%`);
      }

      let { data, error } = await query;

      if (error) {
        alert("一覧取得エラー: " + error.message);
        return;
      }

      let html = `
        <table>
          <tr>
            <th>選択</th>
            <th>コード</th>
            <th>会社名</th>
            <th>カナ</th>
            <th>住所</th>
            <th>部署</th>
            <th>担当者</th>
          </tr>
      `;

      data.forEach(row => {
        const safeId = row.id.replace(/'/g, "\\'");
        html += `
          <tr>
            <td><button onclick="selectRow('${safeId}')">選択</button></td>
            <td>${row.id}</td>
            <td>${row.name}</td>
            <td>${row.kana || ""}</td>
            <td>${row.address || ""}</td>
            <td>${row.department || ""}</td>
            <td>${row.person || ""}</td>
          </tr>
        `;
      });

      html += "</table>";
      document.getElementById("listArea").innerHTML = html;
    }

    // ----------------------------
    // 初期処理
    // ----------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      loadList();
    });

    // ----------------------------
    // 行選択 → 呼び出し元に戻る（汎用版）
    // ----------------------------
    function selectRow(id) {
      if (from) {
        // 例：from=uriage → uriage.html?torihikisaki_id=TK00001
        window.location.href = `${from}.html?torihikisaki_id=${id}`;
      } else {
        // 呼び出し元が指定されていない場合は取引先画面へ
        window.location.href = "torihikisaki.html?id=" + id;
      }
    }

    // ----------------------------
    // 新規作成 → 呼び出し元に応じて遷移
    // ----------------------------
    function goNew() {
      if (from) {
        // 例：from=hinmoku → hinmoku.html（新規）
        window.location.href = `${from}.html`;
      } else {
        window.location.href = "torihikisaki.html";
      }
    }

    // 公開
    window.selectRow = selectRow;
    window.goNew = goNew;
    window.loadList = loadList;
  </script>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { padding: 8px; width: 300px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
  </style>
</head>

<body>

  <h2>取引先一覧</h2>

  <input id="filter" type="text" placeholder="コード / 会社名 / カナ / 部署　/ 担当者">
  <button onclick="loadList()">検索</button>

  <div id="listArea"></div>

  <br>
  <button onclick="goNew()">新規作成へ</button>

  <button onclick="location.href='index.html'">メニューへ</button>

</body>
</html>


