<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>売上／仕入 入力</title>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://omzcbfjtwyygvvgxsiov.supabase.co",
      "sb_publishable_Plndzp1kowyp6OgTwTGwHA_iUIO0ae0"
    );

  const user = localStorage.getItem("user");
  if (!user) {
    window.location.href = "login.html";
  }

    let currentUser = null;


    async function loadUser() {
      const { data } = await supabase.auth.getUser();
      currentUser = data.user;
    }

    const params = new URLSearchParams(window.location.search);
    const kubun = params.get("kubun"); // UR or KI
    const selectedId = params.get("id");

    // ----------------------------
    // 取引先ドロップダウン
    // ----------------------------
    async function loadTorihikisakiSelect() {
      //const { data } = await supabase
      let query = supabase
        .from("torihikisaki")
        .select("id, name")
        .order("id");
      if (kubun === "KI") {
        query = query.not("id", "eq", "TK00000");  // ★ 自社を除外
      }
      const { data } = await query;


      const sel = document.getElementById("torihikisaki_select");
      sel.innerHTML = "";

      const blank = document.createElement("option");
      blank.value = "";
      blank.textContent = "（選択してください）";
      sel.appendChild(blank);

      data.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = `${t.id}：${t.name}`;
        sel.appendChild(opt);
      });
    }

    async function loadTorihikisakiName(id) {
      if (!id) {
        document.getElementById("torihikisaki_name").value = "";
        return;
      }

      const { data } = await supabase
        .from("torihikisaki")
        .select("name")
        .eq("id", id)
        .single();

      document.getElementById("torihikisaki_name").value = data?.name || "";
    }

    // ----------------------------
    // 品目情報
    // ----------------------------
    async function loadHinmokuInfo() {
      const id = document.getElementById("hinmoku_id").value;
      if (!id) return;

      const { data } = await supabase
        .from("hinmoku")
        .select("*")
        .eq("id", id)
        .single();

      if (data) {
        document.getElementById("item").value = data.name;
        document.getElementById("unit").value = data.unit || "";
        document.getElementById("price").value = data.price || "";
        document.getElementById("tax_rate").value = data.tax_rate || "";
      }

      calcAmount();
    }

    function calcAmount() {
      const qty = Number(document.getElementById("quantity").value || 0);
      const price = Number(document.getElementById("price").value || 0);
      document.getElementById("amount").value = qty * price;
    }

    // ----------------------------
    // データ読込
    // ----------------------------
    async function loadData(id) {
      //const table = (kubun === "UR") ? "uriage" : "shiire";
      const table = "kakekin";

      const { data } = await supabase
        .from(table)
        .select("*")
        .eq("id", id)
        .eq("kake_kbn",kubun)
        .single();

      document.getElementById("id").value = data.id;
      document.getElementById("torihikisaki_id").value = data.torihikisaki_id;
      document.getElementById("hinmoku_id").value = data.hinmoku_id;

      document.getElementById("ship_date").value = data.ship_date || "";
      document.getElementById("delivery_date").value = data.delivery_date || "";
      document.getElementById("keijo_date").value = data.keijo_date || "";

      document.getElementById("item").value = data.item;
      document.getElementById("quantity").value = data.quantity;
      document.getElementById("unit").value = data.unit;
      document.getElementById("price").value = data.price;
      document.getElementById("amount").value = data.amount;
      document.getElementById("tax_rate").value = data.tax_rate;

      document.getElementById("memo").value = data.memo || "";

      document.getElementById("torihikisaki_select").value = data.torihikisaki_id;
      document.getElementById("torihikisaki_select").disabled = (kubun === "UR");

      loadTorihikisakiName(data.torihikisaki_id);
      updateButtonState();
    }

    // ----------------------------
    // 採番
    // ----------------------------
    async function generateCode() {
      const prefix = (kubun === "UR") ? "UR" : "KI";

      const { data, error } = await supabase.rpc("get_next_document_code", {
        prefix: prefix
      });

      if (error) {
        alert("採番エラー: " + error.message);
        return null;
      }
      return data;
    }

    // ----------------------------
    // 登録
    // ----------------------------
    async function registerData() {
      const code = await generateCode();
      if (!code) return;

      //const table = (kubun === "UR") ? "uriage" : "shiire";
      const table = "kakekin";

      const data = collectForm();
      data.id = code;
      data.created_by = currentUser.id;

      const { error } = await supabase.from(table).insert(data);

      if (error) alert("登録エラー: " + error.message);
      else {
        alert("登録しました（番号：" + code + "）");
        goList();
      }
    }

    // ----------------------------
    // 更新
    // ----------------------------
    async function updateData() {
      const id = document.getElementById("id").value;
      //const table = (kubun === "UR") ? "uriage" : "shiire";
      const table = "kakekin";

      const data = collectForm();
      data.updated_by = currentUser.id;

      const { error } = await supabase
        .from(table)
        .update(data)
        .eq("id", id)
        .eq("kake_kbn",kubun);

      if (error) alert("更新エラー: " + error.message);
      else {
        alert("更新しました");
        goList();
      }
    }

    // ----------------------------
    // 削除（有効）
    // ----------------------------
    async function deleteData() {
      const id = document.getElementById("id").value;
      if (!confirm("本当に削除しますか？")) return;

      //const table = (kubun === "UR") ? "uriage" : "shiire";
      const table = "kakekin";

      const { error } = await supabase
        .from(table)
        .delete()
        .eq("id", id)
        .eq("kake_kbn",kubun);

      if (error) alert("削除エラー: " + error.message);
      else {
        alert("削除しました");
        goList();
      }
    }

    // ----------------------------
    // フォーム収集
    // ----------------------------
    function collectForm() {
      return {
        kake_kbn: kubun,  // ★ UR or KI を必ず登録
        torihikisaki_id: document.getElementById("torihikisaki_id").value,
        hinmoku_id: document.getElementById("hinmoku_id").value,

        ship_date: document.getElementById("ship_date").value,
        delivery_date: document.getElementById("delivery_date").value,
        keijo_date: document.getElementById("keijo_date").value,

        item: document.getElementById("item").value,
        quantity: document.getElementById("quantity").value,
        unit: document.getElementById("unit").value,
        price: document.getElementById("price").value,
        amount: document.getElementById("amount").value,
        tax_rate: document.getElementById("tax_rate").value,

        memo: document.getElementById("memo").value
      };
    }

    function updateButtonState() {
      const id = document.getElementById("id").value;
      document.getElementById("btnRegister").disabled = !!id;
      document.getElementById("btnUpdate").disabled = !id;
      document.getElementById("btnDelete").disabled = !id;
    }

    // ----------------------------
    // 一覧へ戻る
    // ----------------------------
    window.goList = function() {
      const tid = document.getElementById("torihikisaki_id").value;
      location.href = `list.html?kubun=${kubun}&torihikisaki_id=${tid}`;
    };

    // ----------------------------
    // 初期処理
    // ----------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      await loadUser();
      await loadTorihikisakiSelect();

      document.getElementById("title_kubun").innerText =
        (kubun === "UR") ? "売上入力" : "仕入入力";

      document.getElementById("title_kubun2").innerText =
        (kubun === "UR") ? "◆◆◆ 売上情報 ◆◆◆" : "◆◆◆ 仕入情報 ◆◆◆";

      if (kubun === "UR") {
        document.getElementById("torihikisaki_select").value = "TK00000";
        document.getElementById("torihikisaki_select").disabled = true;
        document.getElementById("torihikisaki_id").value = "TK00000";
        loadTorihikisakiName("TK00000");
      } else if (kubun === "KI") {
        document.getElementById("btnMitumoriDetailList").style.display = "none";
      }

      if (selectedId) {
        await loadData(selectedId);
      }

      // ★ 品目一覧から戻ってきた場合の反映
      const torihikisakiIdFromList = params.get("torihikisaki_id");
      const hinmokuIdFromList = params.get("hinmoku_id");

      // ① 取引先ID の反映
      if (torihikisakiIdFromList) {
        document.getElementById("torihikisaki_id").value = torihikisakiIdFromList;
        document.getElementById("torihikisaki_select").value = torihikisakiIdFromList;
        await loadTorihikisakiName(torihikisakiIdFromList);
        document.getElementById("torihikisaki_select").disabled = true;
      }

      if (hinmokuIdFromList) {
        document.getElementById("hinmoku_id").value = hinmokuIdFromList;
        await loadHinmokuInfo();  // ← 品目名・単価・単位・税率を自動セット
      }

      updateButtonState();
    });

    // ----------------------------
    // ドロップダウン変更
    // ----------------------------
    document.getElementById("torihikisaki_select").addEventListener("change", () => {
      const tid = document.getElementById("torihikisaki_select").value;
      document.getElementById("torihikisaki_id").value = tid;
      loadTorihikisakiName(tid);
    });

    document.getElementById("quantity").addEventListener("input", calcAmount);
    document.getElementById("price").addEventListener("input", calcAmount);

    window.registerData = registerData;
    window.updateData = updateData;
    window.deleteData = deleteData;
    window.loadHinmokuInfo = loadHinmokuInfo;

    window.openHinmokuList = function() {
      const tid = document.getElementById("torihikisaki_id").value;
      const hid = document.getElementById("hinmoku_id").value;

      location.href =
        `hinmoku-list.html?from=uriage&kubun=${kubun}&torihikisaki_id=${tid}&hinmoku_id=${hid}`;
    };


    window.openMitumoriDetailList = function() {
      if (kubun === "UR") {
        location.href = "document_detail-list.html?from=uriage";
      }
    };
  </script>

  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 650px; margin: auto; }
    input, textarea, select { width: 100%; padding: 8px; margin: 8px 0; }
    button { width: 100%; padding: 12px; margin: 10px 0; }
    #id, #torihikisaki_id, #torihikisaki_name, #hinmoku_id { background: #eee; }
  </style>
</head>

<body>

  <h2 id="title_kubun">売上／仕入 入力</h2>

  <h3>◆◆◆ 取引先 ◆◆◆</h3>

  <label>取引先</label>
  <select id="torihikisaki_select"></select>

  <label>取引先ID</label>
  <input id="torihikisaki_id" type="text" readonly>

  <label>取引先名</label>
  <input id="torihikisaki_name" type="text" readonly>

  <h3 id="title_kubun2">売上／仕入情報</h3>
  <label>ID</label>
  <input id="id" type="text" readonly>

  <h3>品目</h3>
  <button onclick="openHinmokuList()">品目一覧へ</button>
  <button id="btnMitumoriDetailList" onclick="openMitumoriDetailList()">見積明細一覧へ</button>

  <label>品目ID</label>
  <input id="hinmoku_id" type="text" readonly>

  <label>品目名</label>
  <input id="item" type="text">

  <label>単位</label>
  <input id="unit" type="text">

  <label>単価</label>
  <input id="price" type="number">

  <label>数量</label>
  <input id="quantity" type="number">

  <label>金額（税抜）</label>
  <input id="amount" type="number" readonly>

  <label>税率</label>
  <input id="tax_rate" type="number" readonly>

  <h3>◆◆◆ 日付 ◆◆◆</h3>

  <label>出荷日</label>
  <input id="ship_date" type="date">

  <label>納品日</label>
  <input id="delivery_date" type="date">

  <label>計上日</label>
  <input id="keijo_date" type="date">

  <h3>◆◆◆ 備考 ◆◆◆</h3>
  <textarea id="memo"></textarea>

  <button id="btnRegister" onclick="registerData()">登録</button>
  <button id="btnUpdate" onclick="updateData()">更新</button>
  <button id="btnDelete" onclick="deleteData()">削除</button>

  <button onclick="goList()">一覧へ</button>
  <button onclick="location.href='index.html'">メニューへ</button>

</body>
</html>
