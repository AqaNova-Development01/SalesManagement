<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>品目マスタ</title>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://omzcbfjtwyygvvgxsiov.supabase.co",
      "sb_publishable_Plndzp1kowyp6OgTwTGwHA_iUIO0ae0"
    );

    let currentUser = null;

    async function loadUser() {
      const { data } = await supabase.auth.getUser();
      currentUser = data.user;
    }

    const params = new URLSearchParams(window.location.search);
    const selectedId = params.get("id");                     // 品目ID（編集時）
    const torihikisaki_id_from_prev = params.get("torihikisaki_id"); // 一覧から渡された取引先ID

    // ----------------------------
    // 取引先一覧をドロップダウンにセット
    // ----------------------------
    async function loadTorihikisakiSelect() {
      const { data } = await supabase
        .from("torihikisaki")
        .select("id, name")
        .order("id");

      const sel = document.getElementById("torihikisaki_select");
      sel.innerHTML = "";

      data.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = `${t.id}：${t.name}`;
        sel.appendChild(opt);
      });
    }

    // ----------------------------
    // 取引先名 自動取得
    // ----------------------------
    async function loadTorihikisakiName(id) {
      if (!id) return;

      const { data } = await supabase
        .from("torihikisaki")
        .select("name")
        .eq("id", id)
        .single();

      document.getElementById("torihikisaki_name").value = data?.name || "";
    }

    // ----------------------------
    // データ読込（編集時）
    // ----------------------------
    async function loadData(id) {
      const { data } = await supabase
        .from("hinmoku")
        .select("*")
        .eq("id", id)
        .single();

      document.getElementById("id").value = data.id;
      document.getElementById("name").value = data.name;
      document.getElementById("unit").value = data.unit || "";
      document.getElementById("price").value = data.price || "";
      document.getElementById("tax_rate").value = data.tax_rate || "";
      document.getElementById("memo").value = data.memo || "";
      document.getElementById("torihikisaki_id").value = data.torihikisaki_id;

      // ドロップダウン反映
      document.getElementById("torihikisaki_select").value = data.torihikisaki_id;
      document.getElementById("torihikisaki_select").disabled = true;

      loadTorihikisakiName(data.torihikisaki_id);
      updateButtonState();
    }

    // ----------------------------
    // 登録（採番対応）
    // ----------------------------
    async function generateHinmokuCode(tid) {
      const { data, error } = await supabase.rpc("get_next_hinmoku_code", {
        tid: tid
      });

      if (error) {
        alert("採番エラー: " + error.message);
        return null;
      }

      return data;
    }

    async function registerData() {
      const tid = document.getElementById("torihikisaki_id").value;
      const name = document.getElementById("name").value.trim();

      if (!tid) {
        alert("取引先を選択してください");
        return;
      }
      if (!name) {
        alert("品目名を入力してください");
        return;
      }

      const code = await generateHinmokuCode(tid);
      if (!code) return;

      const data = collectForm();
      data.id = code;
      data.created_by = currentUser.id;

      const { error } = await supabase.from("hinmoku").insert(data);

      if (error) alert("登録エラー: " + error.message);
      else {
        alert("登録しました（コード：" + code + "）");
        clearForm();
      }
    }

    // ----------------------------
    // 更新
    // ----------------------------
    async function updateData() {
      const id = document.getElementById("id").value;
      const data = collectForm();
      data.updated_by = currentUser.id;

      const { error } = await supabase
        .from("hinmoku")
        .update(data)
        .eq("id", id);

      if (error) alert("更新エラー: " + error.message);
      else {
        alert("更新しました");
        clearForm();
      }
    }

    // ----------------------------
    // フォーム収集
    // ----------------------------
    function collectForm() {
      return {
        name: document.getElementById("name").value,
        unit: document.getElementById("unit").value,
        price: document.getElementById("price").value,
        tax_rate: document.getElementById("tax_rate").value,
        memo: document.getElementById("memo").value,
        torihikisaki_id: document.getElementById("torihikisaki_id").value
      };
    }

    // ----------------------------
    // フォームクリア
    // ----------------------------
    function clearForm() {
      document.getElementById("id").value = "";
      document.getElementById("name").value = "";
      document.getElementById("unit").value = "";
      document.getElementById("price").value = "";
      document.getElementById("tax_rate").value = "";
      document.getElementById("memo").value = "";
      document.getElementById("torihikisaki_id").value = "";
      document.getElementById("torihikisaki_name").value = "";
      updateButtonState();
    }

    // ----------------------------
    // ボタン活性/非活性制御
    // ----------------------------
    function updateButtonState() {
      const id = document.getElementById("id").value;
      const name = document.getElementById("name").value;

      const btnRegister = document.getElementById("btnRegister");
      const btnUpdate = document.getElementById("btnUpdate");

      if (id) {
        btnRegister.disabled = true;
        btnUpdate.disabled = false;
      } else {
        btnRegister.disabled = name.trim() === "";
        btnUpdate.disabled = true;
      }
    }

    // ----------------------------
    // 一覧へ戻る
    // ----------------------------
    window.goList = function() {
      const tid = document.getElementById("torihikisaki_id").value;

      if (tid) {
        location.href = `hinmoku-list.html?torihikisaki_id=${tid}`;
      } else {
        location.href = "hinmoku-list.html";
      }
    };

    // ----------------------------
    // 初期処理
    // ----------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      await loadUser();
      await loadTorihikisakiSelect();

      // 編集モード
      if (selectedId) {
        await loadData(selectedId);
        return;
      }

      // 新規モード（一覧から取引先IDが渡された場合）
      if (torihikisaki_id_from_prev) {
        document.getElementById("torihikisaki_select").value = torihikisaki_id_from_prev;
        document.getElementById("torihikisaki_select").disabled = true;

        document.getElementById("torihikisaki_id").value = torihikisaki_id_from_prev;
        loadTorihikisakiName(torihikisaki_id_from_prev);
      }

      updateButtonState();
    });

    // ----------------------------
    // ドロップダウン変更時
    // ----------------------------
    document.getElementById("torihikisaki_select").addEventListener("change", () => {
      const tid = document.getElementById("torihikisaki_select").value;
      document.getElementById("torihikisaki_id").value = tid;
      loadTorihikisakiName(tid);
    });

    window.registerData = registerData;
    window.updateData = updateData;

  </script>

  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, textarea, select { width: 100%; padding: 8px; margin: 8px 0; }
    button { width: 100%; padding: 12px; margin: 10px 0; }
    #id, #torihikisaki_id, #torihikisaki_name { background: #eee; }
  </style>
</head>

<body>

  <h2>品目マスタ</h2>

  <label>取引先</label>
  <select id="torihikisaki_select"></select>

  <input id="torihikisaki_id" type="text" readonly>
  <input id="torihikisaki_name" type="text" readonly>

  <label>品目ID</label>
  <input id="id" type="text" readonly>

  <label>品目名</label>
  <input id="name" type="text">

  <label>単位</label>
  <input id="unit" type="text">

  <label>基準単価</label>
  <input id="price" type="number">

  <label>税率（10 / 8 など）</label>
  <input id="tax_rate" type="number">

  <label>備考</label>
  <textarea id="memo"></textarea>

  <button id="btnRegister" onclick="registerData()">登録</button>
  <button id="btnUpdate" onclick="updateData()">更新</button>

  <button onclick="goList()">一覧へ</button>
  <button onclick="location.href='index.html'">メニューへ</button>

</body>
</html>