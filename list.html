<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>売上／仕入 一覧</title>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://omzcbfjtwyygvvgxsiov.supabase.co",
      "sb_publishable_Plndzp1kowyp6OgTwTGwHA_iUIO0ae0"
    );

    const params = new URLSearchParams(window.location.search);
    const kubun = params.get("kubun"); // UR or KI
    const torihikisaki_id = params.get("torihikisaki_id") || "";
    let selected_torihikisaki_id = torihikisaki_id || null;

    // ----------------------------
    // 年月ドロップダウン初期化
    // ----------------------------
    function initYearMonth() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;

      const yearSel = document.getElementById("year");
      const monthSel = document.getElementById("month");

      for (let y = year - 3; y <= year + 1; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === year) opt.selected = true;
        yearSel.appendChild(opt);
      }

      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        opt.value = m.toString().padStart(2, "0");
        opt.textContent = m;
        if (m === month) opt.selected = true;
        monthSel.appendChild(opt);
      }
    }

    // ----------------------------
    // 取引先一覧をドロップダウンにセット
    // ----------------------------
    async function loadTorihikisakiList() {
      let query = supabase
        .from("torihikisaki")
        .select("id, name")
        .order("id");
      if (kubun === "KI") {
        query = query.not("id", "eq", "TK00000");  // ★ 自社を除外
      }
      const { data } = await query;

      const list = document.getElementById("torihikisaki_list");

      data.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.name;
        opt.dataset.id = t.id;
        list.appendChild(opt);
      });
    }

    // ----------------------------
    // 取引先名 → ID 自動セット
    // ----------------------------
    function onTorihikisakiNameInput() {
      const name = document.getElementById("torihikisaki_name").value;
      const list = document.getElementById("torihikisaki_list").options;

      for (let opt of list) {
        if (opt.value === name) {
          selected_torihikisaki_id = opt.dataset.id;
          return;
        }
      }
    }

    // ----------------------------
    // 検索処理
    // ----------------------------
    async function search() {
      const year = document.getElementById("year").value;
      const month = document.getElementById("month").value;
      const yymm = year.toString().slice(2) + month;

      const torihikisaki_id = document.getElementById("torihikisaki_id").value;

      let query = supabase
        .from("kakekin")
        .select(`
          id,
          torihikisaki_id,
          hinmoku_id,
          item,
          quantity,
          price,
          amount,
          delivery_date,
          keijo_date,
          torihikisaki(name)
        `)
        .like("id", `%{kubun}${yymm}%`)
        .eq("kake_kbn", kubun)   // ★ UR or KI を必ず絞る
        .order("id", { ascending: false });

      if (kubun === "KI") {
        query = query.not("id", "eq", "TK00000");  // ★ 自社を除外
      }

      // 売上画面から取引先ID連携あり → 固定
      if (selected_torihikisaki_id) {
        query = query.eq("torihikisaki_id", selected_torihikisaki_id);
      } else {
        if (torihikisaki_id) {
          query = query.eq("torihikisaki_id", torihikisaki_id);
        }
      }

      const { data, error } = await query;

      if (error) {
        alert("検索エラー: " + error.message);
        return;
      }

      renderTable(data || []);
    }

    // ----------------------------
    // 一覧描画
    // ----------------------------
    function renderTable(rows) {
      const tbody = document.getElementById("list");
      tbody.innerHTML = "";

      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="9">該当データがありません</td>`;
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td><button onclick="editUriage('${r.id}')">編集</button> </td>
          <td>${r.id}</td>
          <td>${r.torihikisaki?.name || ""}</td>
          <td>${r.item}</td>
          <td>${r.quantity}</td>
          <td>${r.price}</td>
          <td>${r.amount}</td>
          <td>${r.delivery_date || ""}</td>
          <td>${r.keijo_date || ""}</td>
          </tr>
        `;

        tbody.appendChild(tr);
      });
    }

    // ----------------------------
    // 編集画面へ
    // ----------------------------
    window.editUriage = function(id) {
      location.href = `uriage.html?id=${id}`;
    };

    // ----------------------------
    // 初期処理
    // ----------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      initYearMonth();
      await loadTorihikisakiList();

      if (selected_torihikisaki_id) {
        //document.getElementById("torihikisaki_id").value = selected_torihikisaki_id;
        //document.getElementById("torihikisaki_id").readOnly = true;
        document.getElementById("torihikisaki_name").readOnly = true;
      }

      search();
    });

    window.search = search;
    window.onTorihikisakiNameInput = onTorihikisakiNameInput;
  </script>

  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    input, select { padding: 6px; margin: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #eee; }
  </style>
</head>

<body>

  <h2>売上／仕入 一覧</h2>

  <h3>検索条件</h3>

  <label>年</label>
  <input id="year"></select>

  <label>月</label>
  <input id="month"></select>

  <br>

  <label>取引先名</label>
  <input id="torihikisaki_name" placeholder="取引先名"  list="torihikisaki_list" oninput="onTorihikisakiNameInput()">
  <datalist id="torihikisaki_list"></datalist>

  <br>

  <button onclick="search()">検索</button>
  <button onclick="location.reload()">クリア</button>

  <h3>一覧</h3>

  <table>
    <thead>
      <tr>
        <th>操作</th>
        <th>売上ID</th>
        <th>取引先名</th>
        <th>品目名</th>
        <th>数量</th>
        <th>単価</th>
        <th>金額</th>
        <th>納品日</th>
        <th>計上日</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>

  <button onclick="location.href='index.html'">メニューへ</button>

</body>
</html>
