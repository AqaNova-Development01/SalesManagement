<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>取引先マスタ</title>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://omzcbfjtwyygvvgxsiov.supabase.co",
      "sb_publishable_Plndzp1kowyp6OgTwTGwHA_iUIO0ae0"
    );

    let currentUser = null;

    // ----------------------------
    // ログインチェック
    // ----------------------------
    async function checkLogin() {
      const { data } = await supabase.auth.getSession();
      if (!data.session) {
        window.location.href = "login.html";
        return false;
      }
      return true;
    }

    // ----------------------------
    // ログインユーザー取得
    // ----------------------------
    async function loadUser() {
      const { data } = await supabase.auth.getUser();
      currentUser = data.user;
    }

    const params = new URLSearchParams(window.location.search);
    const selectedId = params.get("id");
    const from = params.get("from");   // ★ 呼び出し元画面

    // ----------------------------
    // 取引先コード採番（TK + 5桁連番）
    // ----------------------------
    async function generateTKCode() {
      const prefix = "TK";

      const { data, error } = await supabase
        .from("numbering")
        .select("last_number")
        .eq("code", prefix)
        .single();

      if (error) {
        alert("ナンバリング取得エラー: " + error.message);
        return null;
      }

      const nextNo = data.last_number + 1;

      await supabase
        .from("numbering")
        .update({
          last_number: nextNo,
          updated_at: new Date()
        })
        .eq("code", prefix);

      const num = String(nextNo).padStart(5, "0");
      return `${prefix}${num}`;
    }

    // ----------------------------
    // データ読込（更新時）
    // ----------------------------
    async function loadData(id) {
      const { data, error } = await supabase
        .from("torihikisaki")
        .select("*")
        .eq("id", id)
        .single();

      if (error) {
        alert("データ取得エラー: " + error.message);
        return;
      }

      document.getElementById("id").value = data.id;
      document.getElementById("kana").value = data.kana || "";
      document.getElementById("name").value = data.name;
      document.getElementById("department").value = data.department || "";
      document.getElementById("person").value = data.person || "";
      document.getElementById("postal_code").value = data.postal_code || "";
      document.getElementById("address").value = data.address || "";
      document.getElementById("tel").value = data.tel || "";
      document.getElementById("fax").value = data.fax || "";
      document.getElementById("invoice_number").value = data.invoice_number || "";
      document.getElementById("billing_email_or_url").value = data.billing_email_or_url || "";
      document.getElementById("bank_name").value = data.bank_name || "";
      document.getElementById("bank_branch").value = data.bank_branch || "";
      document.getElementById("bank_account").value = data.bank_account || "";
      document.getElementById("account_holder").value = data.account_holder || "";

      updateButtonState();
    }

    // ----------------------------
    // 登録（入力チェック追加）
    // ----------------------------
    async function registerData() {
      const name = document.getElementById("name").value.trim();
      if (!name) {
        alert("会社名を入力してください");
        return;
      }

      const code = await generateTKCode();
      if (!code) return;

      const data = collectForm();
      data.id = code;
      data.created_by = currentUser.id;

      const { error } = await supabase.from("torihikisaki").insert(data);

      if (error) alert("登録エラー: " + error.message);
      else {
        alert("登録しました（コード：" + code + "）");
        clearForm();
        goList();
      }
    }

    // ----------------------------
    // 更新（入力チェック追加）
    // ----------------------------
    async function updateData() {
      const name = document.getElementById("name").value.trim();
      if (!name) {
        alert("会社名を入力してください");
        return;
      }

      const id = document.getElementById("id").value;
      const data = collectForm();
      data.updated_by = currentUser.id;

      const { error } = await supabase
        .from("torihikisaki")
        .update(data)
        .eq("id", id);

      if (error) alert("更新エラー: " + error.message);
      else {
        alert("更新しました");
        clearForm();
        goList();
      }
    }


    // ----------------------------
    // フォーム収集
    // ----------------------------
    function collectForm() {
      return {
        kana: document.getElementById("kana").value,
        name: document.getElementById("name").value,
        department: document.getElementById("department").value,
        person: document.getElementById("person").value,
        postal_code: document.getElementById("postal_code").value,
        address: document.getElementById("address").value,
        tel: document.getElementById("tel").value,
        fax: document.getElementById("fax").value,
        invoice_number: document.getElementById("invoice_number").value,
        billing_email_or_url: document.getElementById("billing_email_or_url").value,
        bank_name: document.getElementById("bank_name").value,
        bank_branch: document.getElementById("bank_branch").value,
        bank_account: document.getElementById("bank_account").value,
        account_holder: document.getElementById("account_holder").value
      };
    }

    // ----------------------------
    // フォームクリア
    // ----------------------------
    function clearForm() {
      document.getElementById("id").value = "";
      document.getElementById("kana").value = "";
      document.getElementById("name").value = "";
      document.getElementById("department").value = "";
      document.getElementById("person").value = "";
      document.getElementById("postal_code").value = "";
      document.getElementById("address").value = "";
      document.getElementById("tel").value = "";
      document.getElementById("fax").value = "";
      document.getElementById("invoice_number").value = "";
      document.getElementById("billing_email_or_url").value = "";
      document.getElementById("bank_name").value = "";
      document.getElementById("bank_branch").value = "";
      document.getElementById("bank_account").value = "";
      document.getElementById("account_holder").value = "";

      updateButtonState();
    }

    // ----------------------------
    // ボタン活性/非活性制御
    // ----------------------------
    function updateButtonState() {
      const id = document.getElementById("id").value;
      const name = document.getElementById("name").value;

      const btnRegister = document.getElementById("btnRegister");
      const btnUpdate = document.getElementById("btnUpdate");
      //const btnDelete = document.getElementById("btnDelete");

      if (id) {
        btnRegister.disabled = true;
        btnUpdate.disabled = false;
        //btnDelete.disabled = false;
      } else {
        btnRegister.disabled = false;

        if (name.trim() === "") {
          btnUpdate.disabled = true;
          //btnDelete.disabled = true;
        } else {
          btnUpdate.disabled = false;
          //btnDelete.disabled = true;
        }
      }
    }

    // ----------------------------
    // 一覧へ戻る（呼び出し元対応）
    // ----------------------------
    function goList() {
      window.location.href = "torihikisaki-list.html";
    }


    // ----------------------------
    // 初期処理
    // ----------------------------
    window.addEventListener("DOMContentLoaded", async () => {
    
      // ★ ログインチェック
      if (!(await checkLogin())) return;
    
      // ★ ログインユーザー取得
      await loadUser();
    
      // ★ データ読込 or 新規
      if (selectedId) {
        await loadData(selectedId);
      } else {
        updateButtonState();
      }

      document.addEventListener("input", updateButtonState);
      window.registerData = registerData;
      window.updateData = updateData;
      //window.deleteData = deleteData;
      window.goList = goList;
    });
  </script>

  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, textarea { width: 100%; padding: 8px; margin: 8px 0; }
    button { width: 100%; padding: 12px; margin: 10px 0; }
    #id { background: #eee; }
  </style>
</head>

<body>

  <h2>取引先マスタ</h2>

  <label>取引先コード（自動採番）</label>
  <input id="id" type="text" readonly>

  <label>会社名カナ</label>
  <input id="kana" type="text">

  <label>会社名</label>
  <input id="name" type="text">

  <label>部署</label>
  <input id="department" type="text">

  <label>担当者</label>
  <input id="person" type="text">

  <label>郵便番号</label>
  <input id="postal_code" type="text">

  <label>住所</label>
  <textarea id="address"></textarea>

  <label>電話番号</label>
  <input id="tel" type="text">

  <label>FAX番号</label>
  <input id="fax" type="text">

  <label>インボイス番号</label>
  <input id="invoice_number" type="text">

  <label>請求書送付先（メール or URL）</label>
  <input id="billing_email_or_url" type="text">

  <h3>振込先情報</h3>

  <label>銀行名</label>
  <input id="bank_name" type="text">

  <label>支店名</label>
  <input id="bank_branch" type="text">

  <label>口座番号＋種別</label>
  <input id="bank_account" type="text">

  <label>口座名義</label>
  <input id="account_holder" type="text">

  <button id="btnRegister" onclick="registerData()">登録（自動採番）</button>
  <button id="btnUpdate" onclick="updateData()">更新</button>

  <button onclick="goList()">一覧へ</button>
  <button onclick="location.href='index.html'">メニューへ</button>

</body>
</html>
