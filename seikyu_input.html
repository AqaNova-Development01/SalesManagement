<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>請求書入力・集計</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  label { display: block; margin-top: 10px; }
  input, select, textarea { padding: 4px; }
  table { margin-top: 15px; border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 4px; font-size: 12px; }
  .summary { margin-top: 15px; }
</style>
</head>
<body>

<h2>アクア・ノヴァ 販売管理　【 請求書入力・集計 】</h2>

<!-- 請求先・請求年月 -->
<label>取引先</label>
<select id="torihikisaki_select"></select>

<label>請求年</label>
<input type="number" id="seikyu_year" style="width:100px;">

<label>請求月</label>
<input type="number" id="seikyu_month" style="width:60px;">

<button onclick="aggregate()">集計</button>

<hr>

<h3>売上明細（計上日ベース）</h3>
<div id="meisaiArea"></div>

<div class="summary">
  <h3>税区分別集計（インボイス対応）</h3>
  <div id="taxSummary"></div>

  <h3>請求合計</h3>
  <div id="totalSummary"></div>
</div>

<hr>

<h3>自社情報（振込先）</h3>
<div id="jishaInfo"></div>

<hr>

<label>請求日</label>
<input type="date" id="seikyu_date">

<label>備考</label>
<textarea id="note" style="width:400px;height:60px;"></textarea>

<br>
<button onclick="registerSeikyu()">請求書登録</button>
<button onclick="loadSeikyuList()">請求書一覧</button>

<div id="seikyuListArea"></div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://omzcbfjtwyygvvgxsiov.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_Plndzp1kowyp6OgTwTGwHA_iUIO0ae0";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const JISHA_ID = "00000000-0000-0000-0000-000000000001";

  let currentUriage = [];   // 集計対象の売上明細
  let currentTaxSummary = null;
  let currentTotals = null;

  // 初期ロード
  window.onload = async () => {
    await loadTorihikisakiList();
    await loadJishaInfo();

    const today = new Date();
    document.getElementById("seikyu_year").value = today.getFullYear();
    document.getElementById("seikyu_month").value = today.getMonth() + 1;
    document.getElementById("seikyu_date").value = today.toISOString().split("T")[0];
  };

  // 取引先一覧
  async function loadTorihikisakiList() {
    const { data, error } = await supabase.from("torihikisaki").select("*").order("kana");
    if (error) {
      alert("取引先取得エラー: " + error.message);
      return;
    }
    const sel = document.getElementById("torihikisaki_select");
    sel.innerHTML = "<option value=''>選択してください</option>";
    data.forEach(t => {
      sel.innerHTML += `<option value="${t.id}">${t.kana} / ${t.name}</option>`;
    });
  }

  // 自社情報（振込先）
  async function loadJishaInfo() {
    const { data, error } = await supabase
      .from("torihikisaki")
      .select("*")
      .eq("id", JISHA_ID)
      .single();

    if (error) {
      document.getElementById("jishaInfo").innerText = "自社情報取得エラー: " + error.message;
      return;
    }

    const d = data;
    let html = "";
    html += `<div>${d.name}</div>`;
    if (d.postal_code || d.address1 || d.address2) {
      html += `<div>〒${d.postal_code || ""} ${d.address1 || ""} ${d.address2 || ""}</div>`;
    }
    if (d.tel) {
      html += `<div>TEL: ${d.tel}</div>`;
    }
    if (d.bank_name || d.bank_branch || d.bank_account) {
      html += `<div>振込先：${d.bank_name || ""} ${d.bank_branch || ""} ${d.bank_account || ""}</div>`;
    }
    document.getElementById("jishaInfo").innerHTML = html;
  }

  // 集計
  async function aggregate() {
    const torihikisaki_id = document.getElementById("torihikisaki_select").value;
    const year = Number(document.getElementById("seikyu_year").value);
    const month = Number(document.getElementById("seikyu_month").value);

    if (!torihikisaki_id || !year || !month) {
      alert("取引先・請求年月を指定してください");
      return;
    }

    const start = new Date(year, month - 1, 1);
    const end = new Date(year, month, 0); // 月末

    const startStr = start.toISOString().split("T")[0];
    const endStr = end.toISOString().split("T")[0];

    const { data, error } = await supabase
      .from("uriage")
      .select("*")
      .eq("torihikisaki_id", torihikisaki_id)
      .gte("keijo_date", startStr)
      .lte("keijo_date", endStr)
      .order("keijo_date", { ascending: true });

    if (error) {
      alert("売上取得エラー: " + error.message);
      return;
    }

    currentUriage = data || [];
    renderMeisai();
    calcTaxSummary();
  }

  // 売上明細表示
  function renderMeisai() {
    if (!currentUriage.length) {
      document.getElementById("meisaiArea").innerHTML = "対象データがありません。";
      return;
    }

    let html = "<table><tr><th>計上日</th><th>売上日</th><th>品目</th><th>数量</th><th>単価</th><th>税率</th><th>金額（税込）</th></tr>";
    currentUriage.forEach(r => {
      html += `
        <tr>
          <td>${r.keijo_date}</td>
          <td>${r.uriage_date}</td>
          <td>${r.hinmoku_name}</td>
          <td style="text-align:right;">${r.qty}</td>
          <td style="text-align:right;">${r.unit_price}</td>
          <td style="text-align:right;">${(r.tax_rate * 100).toFixed(0)}%</td>
          <td style="text-align:right;">${r.amount}</td>
        </tr>
      `;
    });
    html += "</table>";
    document.getElementById("meisaiArea").innerHTML = html;
  }

  // 税区分別集計
  function calcTaxSummary() {
    const groups = {}; // tax_rateごと
    let grandTotal = 0;

    currentUriage.forEach(r => {
      const rate = Number(r.tax_rate || 0);
      const key = rate.toFixed(2);
      const amount = Number(r.amount || 0);
      grandTotal += amount;

      if (!groups[key]) {
        groups[key] = { rate, zeinuki: 0, zei: 0, zeikomi: 0 };
      }

      if (rate > 0) {
        const zeinuki = amount / (1 + rate);
        const zei = amount - zeinuki;
        groups[key].zeinuki += zeinuki;
        groups[key].zei += zei;
        groups[key].zeikomi += amount;
      } else {
        groups[key].zeinuki += amount;
        groups[key].zeikomi += amount;
      }
    });

    currentTaxSummary = groups;
    currentTotals = { grandTotal };

    // 表示
    let html = "<table><tr><th>税率</th><th>課税標準額（税抜）</th><th>税額</th><th>税込額</th></tr>";
    const rates = Object.keys(groups).sort((a,b)=>Number(a)-Number(b));
    rates.forEach(k => {
      const g = groups[k];
      html += `
        <tr>
          <td>${(g.rate * 100).toFixed(0)}%</td>
          <td style="text-align:right;">${Math.round(g.zeinuki)}</td>
          <td style="text-align:right;">${Math.round(g.zei)}</td>
          <td style="text-align:right;">${Math.round(g.zeikomi)}</td>
        </tr>
      `;
    });
    html += "</table>";
    document.getElementById("taxSummary").innerHTML = html;

    document.getElementById("totalSummary").innerHTML =
      `税込合計：${Math.round(grandTotal)} 円`;
  }

  // 請求書登録
  async function registerSeikyu() {
    if (!currentUriage.length) {
      alert("集計済みの売上がありません。");
      return;
    }
    if (!currentTaxSummary || !currentTotals) {
      alert("集計が未実行です。");
      return;
    }

    const torihikisaki_id = document.getElementById("torihikisaki_select").value;
    const year = Number(document.getElementById("seikyu_year").value);
    const month = Number(document.getElementById("seikyu_month").value);
    const seikyu_date = document.getElementById("seikyu_date").value;
    const note = document.getElementById("note").value;

    if (!torihikisaki_id || !year || !month || !seikyu_date) {
      alert("取引先・請求年月・請求日を確認してください");
      return;
    }

    // 税抜合計・税額合計
    let total_zeinuki = 0;
    let total_zei = 0;
    Object.values(currentTaxSummary).forEach(g => {
      total_zeinuki += g.zeinuki;
      total_zei += g.zei;
    });

    const header = {
      seikyu_date,
      torihikisaki_id,
      seikyu_year: year,
      seikyu_month: month,
      total: Math.round(total_zeinuki),
      tax: Math.round(total_zei),
      grand_total: Math.round(currentTotals.grandTotal),
      note
    };

    const { data: headerData, error: headerError } = await supabase
      .from("seikyu")
      .insert([header])
      .select()
      .single();

    if (headerError) {
      alert("請求書ヘッダー登録エラー: " + headerError.message);
      return;
    }

    const seikyu_id = headerData.id;

    const meisai = currentUriage.map(r => ({
      seikyu_id,
      uriage_id: r.id,
      hinmoku_name: r.hinmoku_name,
      qty: r.qty,
      unit_price: r.unit_price,
      amount: r.amount
    }));

    const { error: meisaiError } = await supabase
      .from("seikyu_meisai")
      .insert(meisai);

    if (meisaiError) {
      alert("請求書明細登録エラー: " + meisaiError.message);
      return;
    }

    alert("請求書を登録しました");
    loadSeikyuList();
  }

  // 請求書一覧
  async function loadSeikyuList() {
    const { data, error } = await supabase
      .from("seikyu")
      .select("*")
      .order("seikyu_date", { ascending: false });

    if (error) {
      alert("請求書一覧取得エラー: " + error.message);
      return;
    }

    if (!data.length) {
      document.getElementById("seikyuListArea").innerHTML = "登録済み請求書はありません。";
      return;
    }

    let html = "<h3>請求書一覧</h3>";
    html += "<table><tr><th>ID</th><th>請求日</th><th>取引先</th><th>年</th><th>月</th><th>税込合計</th></tr>";
    data.forEach(r => {
      html += `
        <tr>
          <td>${r.id}</td>
          <td>${r.seikyu_date}</td>
          <td>${r.torihikisaki_id}</td>
          <td>${r.seikyu_year}</td>
          <td>${r.seikyu_month}</td>
          <td style="text-align:right;">${r.grand_total}</td>
        </tr>
      `;
    });
    html += "</table>";
    document.getElementById("seikyuListArea").innerHTML = html;
  }

  // グローバルに関数を出す
  window.aggregate = aggregate;
  window.registerSeikyu = registerSeikyu;
  window.loadSeikyuList = loadSeikyuList;
</script>

</body>
</html>