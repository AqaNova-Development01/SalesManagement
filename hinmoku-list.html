<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>品目一覧</title>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://omzcbfjtwyygvvgxsiov.supabase.co",
      "sb_publishable_Plndzp1kowyp6OgTwTGwHA_iUIO0ae0"
    );

    const params = new URLSearchParams(window.location.search);
    const torihikisaki_id = params.get("torihikisaki_id");
    const from = params.get("from");   // 呼び出し元画面（uriage, shiire, document, hinmoku）
    const kubun = params.get("kubun"); // ★ UR or KI（売上/仕入区分）
    let selected_torihikisaki_id = params.get("torihikisaki_id") || null;

    // ----------------------------
    // 取引先一覧をドロップダウンにセット
    // ----------------------------
    async function loadTorihikisakiList() {

      //const { data } = await supabase
      let query = supabase
        .from("torihikisaki")
        .select("id, name")
        .order("id");

      if (kubun === "KI") {
        query = query.not("id", "eq", "TK00000");  // ★ 自社を除外
      }
      const { data } = await query;

      const list = document.getElementById("torihikisaki_list");

      data.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.name;
        opt.dataset.id = t.id;
        list.appendChild(opt);
      });
    }

    // ----------------------------
    // 取引先名 自動取得
    // ----------------------------
    async function loadTorihikisakiName() {
      if (!torihikisaki_id) {
        document.getElementById("torihikisaki_name").value = "";
        return;
      }

      const { data } = await supabase
        .from("torihikisaki")
        .select("name")
        .eq("id", torihikisaki_id)
        .single();

      document.getElementById("torihikisaki_name").value = data?.name || "";
    }

    // ----------------------------
    // 取引先名 → ID 自動セット
    // ----------------------------
    function onTorihikisakiNameInput() {
      const name = document.getElementById("torihikisaki_name").value;

      if (!name) {
        selected_torihikisaki_id = null;
      }

      const list = document.getElementById("torihikisaki_list").options;

      for (let opt of list) {
        if (opt.value === name) {
          selected_torihikisaki_id = opt.dataset.id;
          return;
        }
      }
    }

    // ----------------------------
    // 一覧読み込み
    // ----------------------------
    async function loadList() {
      const filter = document.getElementById("filter").value.trim();

      onTorihikisakiNameInput();

      let query = supabase
        .from("hinmoku")
        .select("*, torihikisaki:torihikisaki_id(name)")
        .order("name");

      if (selected_torihikisaki_id) {
        query = query.eq("torihikisaki_id", selected_torihikisaki_id);
      }
      if (kubun === "KI") {
        query = query.not("torihikisaki_id", "eq", "TK00000");  // ★ 自社を除外
      }

      if (filter) {
        query = query.or(`id.ilike.%${filter}%,name.ilike.%${filter}%`);
      }

      let { data, error } = await query;

      if (error) {
        alert("一覧取得エラー: " + error.message);
        return;
      }

      let html = `
        <table>
          <tr>
            <th>選択</th>
            <th>品目ID</th>
            <th>品目名</th>
            <th>取引先</th>
            <th>単価</th>
          </tr>
      `;

      data.forEach(row => {
        html += `
          <tr>
            <td><button onclick="selectRow('${row.id}', '${row.torihikisaki_id}')">選択</button></td>
            <td>${row.id}</td>
            <td>${row.name}</td>
            <td>${row.torihikisaki?.name || ""}</td>
            <td>${row.price || ""}</td>
          </tr>
        `;
      });

      html += "</table>";
      document.getElementById("listArea").innerHTML = html;
    }

    // ----------------------------
    // 行選択 → 呼び出し元に戻る（完全版）
    // ----------------------------
    window.selectRow = function(id, tid) {

      // ★ 売上 or 仕入から来た場合（kubun が必要）
      if (from === "uriage" || from === "shiire") {
        window.location.href =
          `${from}.html?kubun=${kubun}&hinmoku_id=${id}&torihikisaki_id=${tid}&from=hinmoku`;
        return;
      }

      // ★ 見積画面から来た場合（kubun 不要）
      if (from === "document") {
        window.location.href =
          `document.html?hinmoku_id=${id}&torihikisaki_id=${tid}&from=hinmoku`;
        return;
      }

      // ★ 品目画面から来た場合（従来通り）
      window.location.href = "hinmoku.html?id=" + id;
    };

    // ----------------------------
    // 新規作成 → 呼び出し元に応じて遷移
    // ----------------------------
    window.goNew = function() {

      if (from === "uriage" || from === "shiire") {
        window.location.href = `${from}.html?kubun=${kubun}`;
        return;
      }

      if (from === "document") {
        window.location.href = "document.html";
        return;
      }

      window.location.href = "hinmoku.html";
    };

    // ----------------------------
    // 初期処理
    // ----------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      await loadTorihikisakiList();

      if (torihikisaki_id) {
        selected_torihikisaki_id = torihikisaki_id;
        await loadTorihikisakiName();
        document.getElementById("torihikisaki_name").readOnly = true;
      }

      loadList();
    });

    window.loadList = loadList;
  </script>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { padding: 8px; width: 300px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
  </style>
</head>

<body>

  <h2>品目一覧</h2>

  <input id="torihikisaki_name" placeholder="取引先名" list="torihikisaki_list"
         oninput="onTorihikisakiNameInput()" onchange="onTorihikisakiNameInput()">
  <datalist id="torihikisaki_list"></datalist>

  <input id="filter" type="text" placeholder="品目ID / 品目名">
  <button onclick="loadList()">検索</button>

  <div id="listArea"></div>

  <br>
  <button onclick="goNew()">新規作成へ</button>

  <button onclick="location.href='index.html'">メニューへ</button>

</body>
</html>
